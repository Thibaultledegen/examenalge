import csv
from random import randint

class Batch:
    def __init__(self,quantity, costperunit):
        self.quantity = quantity
        self.costperunit = costperunit
    def __str__(self):
        return f"Batch(quantity={self.quantity}, cost_per_unit={self.costperunit})"
class Product:
    def __init__(self,product_name, holding_cost,stock_penalty):
        self.product_name = product_name
        self.holding_cost = holding_cost
        self.stock_penalty = stock_penalty
        self.batches = []
    def add_batch(self,quantity, cost_per_unit):
        self.batches.append(Batch(quantity, cost_per_unit))

    def fulfill_demand(self,demand):
        overblijf = demand
        while overblijf > 0 and self.batches is not None:
            top = self.batches[-1]
            if top.quantity > overblijf:
                top.quantity -= overblijf
                return 0
            else:
                overblijf -= top.quantity
                self.batches.pop()
        return overblijf*self.stock_penalty
    def calc_holding_cost(self):
        kosten = 0
        for batch in self.batches:
            kosten += batch.holding_cost
        return kosten

    def __str__(self):
        result = f"Product [{self.product_name}]:\n"
        for batch in self.batches:
            result += f"{batch}\n"
        return result


class Inventory_Manager:
    def __init__(self):
        self.products = {}

    def add_product(self, product_name, holding_cost, stockout_penalty):
        if product_name in self.products:
            print(f"Product [{product_name}] already exists.")
        else:
            self.products[product_name] = Product(product_name, holding_cost,stockout_penalty)

    def restock_product(self, product_name, quantity, cost_per_unit):
        if product_name not in self.products:
            print(f"Product [{product_name}] not found")
        else:
            self.products[product_name].add_batch(quantity, cost_per_unit)

    def simulate_demand(self, min_demand=0, max_demand=20):
        demand = {}
        for name in self.products:
            demand[name] = randint(min_demand, max_demand)
        return demand

    def simulate_day(self, demand):
        total_holding = 0
        total_stockout = 0

        for name, qty in demand.items():
            product = self.products[name]
            stockout_cost = product.fulfill_demand(qty)
            total_stockout += stockout_cost
            total_holding += product.calc_holding_cost()

        return total_holding, total_stockout

    def save_to_csv(self, filename):
        with open(filename, 'w', newline='') as f:
            writer = csv.writer(f)
            for name, product in self.products.items():
                for batch in product.batches:
                    writer.writerow([name, batch.quantity, batch.costperunit])

    def load_from_csv(self, filename):
        with open(filename, 'r') as f:
            reader = csv.reader(f)
            for row in reader:
                product_name = row[0]
                quantity = int(row[1])
                cost = float(row[2])

                if product_name not in self.products:
                    self.products[product_name] = Product(product_name, holding_cost=0, stock_penalty=0)

                self.products[product_name].add_batch(quantity, cost)

    def print_inventory(self):
        print("Current Inventory:")
        for product in self.products.values():
            print(product)

def main():
    inv = Inventory_Manager()

    inv.add_product("Widget", 0.5, 1.0)
    inv.add_product("Gadget", 0.3, 0.8)

    inv.restock_product("Widget", 100, 2.5)
    inv.restock_product("Widget", 50, 2.0)
    inv.restock_product("Gadget", 70, 3.0)
    inv.restock_product("Gadget", 40, 2.8)

    inv.print_inventory()

    demand = inv.simulate_demand()
    print("Simulated demand:", demand)

    holding, stockout = inv.simulate_day(demand)
    print("Holding cost:", holding)
    print("Stockout cost:", stockout)

    inv.save_to_csv("inventory.csv")
    print("Saved to inventory.csv")

if __name__ == "__main__":
    main()
